for(var tm,lookup,countries={},filters=[],cm={},icons=[],i=1;i<80;i++)icons[i]=generateIcon(i);for(cc in lookup){cm[cc]={};cm[cc].latlng=new GLatLng(lookup[cc].lat,lookup[cc].lon);cm[cc].marker=null;cm[cc].items=[];cm[cc].urls=[];cm[cc].name=null}lookup=null;
function onLoad(){tm=TimeMap.init({mapId:"map",timelineId:"timeline",scrollTo:"now",options:{mapType:"normal",mapCenter:new GLatLng(30,18),centerMapOnItems:false,mapZoom:2},datasets:[{id:"bloggers",title:"Bloggers",type:"jsonp",options:{url:Drupal.settings.basePath+"data/items.json&callback=",preloadFunction:function(a){return a.items}}}],bandIntervals:[Timeline.DateTime.MONTH,Timeline.DateTime.YEAR],dataDisplayedFunction:function(a){a.map.setZoom(2);a.addFilterChain("counter",function(b){var c=b.opts.cc;
if(isNaN(countries[c]))countries[c]=1;else countries[c]++;if(typeof cm[c]!="undefined"){var d=cm[c].items.indexOf(b.getTitle());if(!cm[c].name)cm[c].name=b.opts.c;if(d==-1){cm[c].items.push(b.getTitle());cm[c].urls.push(b.opts.url)}}},function(){});a.addFilter("counter",function(b){return TimeMap.filters.hideFuture(b)});a.filter("counter");if(!filters.length)for(cc in countries)countries[cc]>0&&dynamicSizeMarker(cc,countries[cc]);updateTimeframe(a.timeline.getBand(0));$(".timeline-message-container").hide();
addSocialBlocks();a.timeline.getBand(0).addOnScrollListener(function(){updateTimeframe(a.timeline.getBand(0));countries={};a.filter("counter");if(!filters.length)for(cc in cm)if(countries[cc]>0)dynamicSizeMarker(cc,countries[cc]);else if(cm[cc].marker){a.map.removeOverlay(cm[cc].marker);cm[cc].marker=null}})}});tm.addFilter("map",TimeMap.filters.hasSelectedTag);tm.addFilter("timeline",TimeMap.filters.hasSelectedTag);tm.addFilter("map",TimeMap.filters.showAll)}
TimeMap.filters.hideFuture=function(a){var b=a.dataset.timemap.timeline.getBand(0).getMaxVisibleDate().getTime();if(a.event!==null)if(a.event.getStart().getTime()>b){b=cm[a.opts.cc].items.indexOf(a.getTitle());if(b!=-1){cm[a.opts.cc].items.splice(b,1);cm[a.opts.cc].urls.splice(b,1)}return false}return true};TimeMap.filters.hasSelectedTag=function(a){if(!filters.length)return true;if(a.opts.tags)return filters.indexOf(a.opts.tags)>=0;return false};
TimeMap.filters.showAll=function(){if(!filters.length)return false;return true};function generateIcon(a){var b=Math.round((a-1)*64/79+16),c={};c.width=b;c.height=b;c.primaryColor="#ff0000";c.label=String(a);c.labelSize=12;c.labelColor="#1f1f1f";c.shape="circle";return MapIconMaker.createFlatIcon(c)}
function dynamicSizeMarker(a,b){if(typeof cm[a]!="undefined"){cm[a].marker&&tm.map.removeOverlay(cm[a].marker);cm[a].marker=new GMarker(cm[a].latlng,{icon:icons[b]});GEvent.addListener(cm[a].marker,"click",function(){cm[a].marker.openInfoWindowHtml(htmlList(cm[a].items,cm[a].urls,a))});GEvent.addListener(cm[a].marker,"infowindowopen",updateInfoList);tm.map.addOverlay(cm[a].marker)}}
function htmlList(a,b,c){var d='<div class="infodescription list">';d+='<span class="'+c+'"><img src="./sites/all/themes/gv/images/flags/'+c.toLowerCase()+'.gif"> <a href="bloggers/'+cm[c].name+'">'+cm[c].name+"</a></span>";for(c=0;c<a.length;c++)d+='<a href="'+b[c]+'">'+a[c]+"</a><br/>";return d+"</div>"}function removeSizeMarkers(){for(cc in cm)if(cm[cc].marker){tm.map.removeOverlay(cm[cc].marker);cm[cc].marker=null}}var loadedCC=false;
function updateInfoList(a){var b=$(".infodescription span a").attr("href").split("/",2),c=$(".infodescription span").attr("class");if(loadedCC!=c){loadedCC=c;c="views/ajax?view_name="+b[0]+"&view_display_id=page_1&view_args="+c+"&view_path="+b[0]+"%2F"+c+"&pager_element=0";typeof a!="object"?$.ajax({url:a,data:"ajax=1",success:function(d){var e=$("#sub #quickinfo");if(e.length)e.html(d);else{$("#bloggers-by-country").remove();$("#sub").prepend('<div id="quickinfo">'+d+"</div>").css("padding","10px 0")}}}):
$.getJSON(c,function(d,e){if(e=="success"&&d.status){var f=$("#sub #bloggers-by-country");if(f.length)f.html("<h3>Bloggers arrested or harassed in "+b[1]+"</h3>"+d.display+"</div>");else{$("#quickinfo").remove();$("#sub").prepend('<div id="bloggers-by-country"><h3>Bloggers arrested or harassed in '+b[1]+"</h3>"+d.display+"</div>")}$(".pager a").each(function(){var g=$(this).attr("href").split("&",1);$(this).attr("href",g[0])})}})}}
Drupal.behaviors.gv_timemap=function(){$("#tm-all").attr("checked",true);$("#tmfilters input[type=checkbox]:not('#tm-all')").each(function(){$(this).attr("checked",false)});$("#tmfilters input[type=checkbox]").click(function(){var b=$(this).val(),c=filters.indexOf(b);if($(this).is(":checked"))if(b=="All"){filters=[];$("#tmfilters input[type=checkbox]:not('#tm-all')").each(function(){$(this).attr("checked",false)})}else{var d=$("#tm-all");d.is(":checked")&&d.attr("checked",false);removeSizeMarkers();
if(c==-1){filters.push(b);tm.filter("timeline");tm.timeline.layout();tm.datasets.bloggers.each(function(e){for(_filter in filters)if(e.opts.tags.indexOf(filters[_filter])!=-1){e.showPlacemark();e.visible=true}});return}}else c!=-1&&filters.splice(c,1);tm.filter("map");tm.filter("timeline");tm.timeline.layout()});var a=new Date;$("#tm-nav button").click(function(){var b=$(this).attr("title");if(b=="earliest")tm.timeline.getBand(0).setCenterVisibleDate(tm.eventSource.getEarliestDate());else b=="latest"?
tm.timeline.getBand(0).setCenterVisibleDate(tm.eventSource.getLatestDate()):tm.timeline.getBand(0).setCenterVisibleDate(a);return false})};function updateTimeframe(a){var b=(new String(a.getMinVisibleDate())).split(/\s/);a=(new String(a.getMaxVisibleDate())).split(/\s/);b=b[1]+" "+(!$.browser.msie?b[3]:b[b.length-1]);a=a[1]+" "+(!$.browser.msie?a[3]:a[a.length-1]);$("#timeframe").html(b+" - "+a)}
function addSocialBlocks(){$.ajaxSetup({async:false});$("head").append("<link>").children(":last").attr({rel:"stylesheet",type:"text/css",href:"http://widgets.twimg.com/j/1/widget.css"});$.getScript("http://widgets.twimg.com/j/1/widget.js",function(){eval("new TWTR.Widget({search: 'from:advox OR @advox OR #advox',id: 'twtr-search-widget',loop: false,title: '',subject: '',width:320,height:260,theme: {shell: {background:'#D8DFEA',color:'#fff'},tweets:{background:'#fff',color:'#333333',links:'#3B5998'}}}).render().start();")});
$.ajaxSetup({async:true})}if(typeof Array.indexOf=="undefined")Array.prototype.indexOf=function(a,b,c){b=+b||0;for(var d=this.length;b<d;b++)if(this[b]===a||c&&this[b]==a)return b;return-1};